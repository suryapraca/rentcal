<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulasi Biaya Sewa Kendaraan</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

<style>
    #map { height: 500px; }
</style>
</head>

<body class="bg-dark">

<div class="container mt-4">
    <h2 class="text-center text-light mb-3">Simulasi Biaya Pelayanan Sewa Kendaraan</h2>

    <div id="map" class="mb-3"></div>

    <!-- FORM -->
    <div class="row g-3 text-light">
        <div class="col-md-6">
            <label>Jenis BBM</label>
            <select id="fuelType" class="form-select">
                <option value="pertalite">Pertalite - Rp10.000</option>
                <option value="biosolar">Biosolar - Rp6.800</option>
            </select>
        </div>

        <div class="col-md-6">
            <label>Jenis Mobil</label>
            <select id="carType" class="form-select">
                <option value="innovaReborn24">Innova Reborn Diesel</option>
                <option value="innovaZenix20">Innova Zenix</option>
                <option value="hiacePremio28">Hiace Premio</option>
            </select>
        </div>

        <div class="col-md-6">
            <label>Tanggal Mulai</label>
            <input type="date" id="startDate" class="form-control">
        </div>

        <div class="col-md-6">
            <label>Tanggal Selesai</label>
            <input type="date" id="endDate" class="form-control">
        </div>

        <div class="col-12">
            <input type="checkbox" id="useDriver"> Gunakan Driver <br>
            <input type="checkbox" id="useToll"> Gunakan Tol <br>
            <input type="checkbox" id="roundTrip"> Pulang Pergi (PP)
        </div>

        <div class="col-12">
            <button id="calculateDistance" class="btn btn-primary w-100">Hitung Biaya</button>
            <button id="sendWhatsApp" class="btn btn-success w-100 mt-2 d-none">Kirim ke WhatsApp</button>
        </div>
    </div>

    <!-- RESULT -->
    <div id="result" class="alert alert-info mt-4 d-none">
        <b>Titik Awal:</b> <span id="startPointResult"></span><br>
        <b>Tujuan:</b> <span id="endPointResult"></span><br>
        <b>Jarak:</b> <span id="distanceResult"></span><br>
        <b>Durasi:</b> <span id="rentalDurationResult"></span><br>
        <b>Total Biaya:</b> <span id="totalCostResult"></span><br>
        <b>Harga Agent:</b> <span id="agentPriceResult"></span><br>
        <b>Harga Customer:</b> <span id="customerPriceResult"></span>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
/* ================= CONFIG ================= */
const fuelEfficiency = 7;
const fuelPrices = { pertalite: 10000, biosolar: 6800 };
const carPrices = {
    innovaReborn24: 400000,
    innovaZenix20: 450000,
    hiacePremio28: 800000
};
const driverStayCost = 150000;
const driverMealCost = 50000;

/* ================= MAP INIT ================= */
const map = L.map('map').setView([-7.2575, 112.7521], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let markers = [];
let route;

/* ================= HELPER ================= */
function rentalDays() {
    const s = new Date(startDate.value);
    const e = new Date(endDate.value);
    return Math.max(1, Math.ceil((e - s) / 86400000) + 1);
}

function driverCost(distance) {
    if (distance < 30) return 200000;
    if (distance <= 500) return 300000;
    if (distance <= 600) return 400000;
    return 500000;
}

/* ================= ROUTE ================= */
function addPoint(latlng) {
    if (markers.length >= 2) return;
    markers.push(L.marker(latlng).addTo(map));

    if (markers.length === 2) {
        if (route) map.removeControl(route);

        route = L.Routing.control({
            waypoints: markers.map(m => m.getLatLng()),
            createMarker: () => null
        }).addTo(map);

        route.on('routesfound', e => calculate(e.routes[0].summary.totalDistance / 1000));
    }
}

/* ================= CALC ================= */
function calculate(distance) {
    const days = rentalDays();
    let fuelCost = (distance / fuelEfficiency) * fuelPrices[fuelType.value];
    let carCost = carPrices[carType.value] * days;
    let driver = 0, stay = 0, meal = 0, toll = 0;

    if (useDriver.checked) {
        driver = driverCost(distance) * days;
        stay = days > 1 ? driverStayCost * (days - 1) : 0;
        meal = driverMealCost * days;
    }
    if (useToll.checked) toll = distance * 1000;
    if (roundTrip.checked) fuelCost *= 2, toll *= 2;

    const total = fuelCost + carCost + driver + stay + meal + toll;

    result.classList.remove('d-none');
    sendWhatsApp.classList.remove('d-none');

    distanceResult.innerText = distance.toFixed(1) + " km";
    rentalDurationResult.innerText = days + " hari";
    totalCostResult.innerText = "Rp " + total.toLocaleString('id-ID');
    agentPriceResult.innerText = "Rp " + (total * 1.1).toLocaleString('id-ID');
    customerPriceResult.innerText = "Rp " + (total * 1.2).toLocaleString('id-ID');
}

/* ================= EVENTS ================= */
map.on('click', e => addPoint(e.latlng));

calculateDistance.onclick = () => {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    if (route) map.removeControl(route);
};

sendWhatsApp.onclick = () => {
    const msg = `Halo Admin Asrent,%0AEstimasi harga sewa:%0A${totalCostResult.innerText}`;
    window.open(`https://wa.me/?text=${msg}`, '_blank');
};
</script>

</body>
</html>
